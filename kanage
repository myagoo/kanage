#!/bin/bash

# kanage - Kanata Config Manager
# Manages kanata keyboard configurations on macOS using launchctl

set -euo pipefail

# Configuration
KANATA_CONFIG_DIR="${HOME}/.config/kanata"
KANATA_CONFIG_FILE="${KANATA_CONFIG_DIR}/kanata.kbd"
EDITOR="${KANAGE_EDITOR:-nvim}"

KANATA_LOG="/var/log/kanata.log"
KANAGE_NAMESPACE="com.kanage"
KANATA_SERVICE="${KANAGE_NAMESPACE}.kanata"
KANATA_PLIST="/Library/LaunchDaemons/${KANATA_SERVICE}.plist"
KARABINER_DAEMON_SERVICE="${KANAGE_NAMESPACE}.karabiner-vhiddaemon"
KARABINER_DAEMON_PLIST="/Library/LaunchDaemons/${KARABINER_DAEMON_SERVICE}.plist"
KARABINER_MANAGER_SERVICE="${KANAGE_NAMESPACE}.karabiner-vhidmanager"
KARABINER_MANAGER_PLIST="/Library/LaunchDaemons/${KARABINER_MANAGER_SERVICE}.plist"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Error handling
error() {
    echo -e "${RED}Error:${NC} $1" >&2
    exit 1
}

info() {
    echo -e "${GREEN}Info:${NC} $1"
}

warn() {
    echo -e "${YELLOW}Warning:${NC} $1"
}

# Check if kanata config directory exists
check_config_dir() {
    if [[ ! -d "$KANATA_CONFIG_DIR" ]]; then
        error "Kanage config directory not found: $KANATA_CONFIG_DIR"
    fi
}

# Check if service is loaded
check_service() {
    if ! sudo launchctl list "$KANATA_SERVICE" &>/dev/null; then
        warn "Kanata service '$KANATA_SERVICE' not found or not loaded"
        return 1
    fi
    return 0
}

# Check if a system service is loaded
check_system_service() {
    local service_name="$1"
    if sudo launchctl print "system/${service_name}" &>/dev/null; then
        return 0
    else
        return 1
    fi
}

# Start kanata service
start_service() {
    if check_service; then
        info "Service '$KANATA_SERVICE' is already running"
        return 0
    fi
    
    info "Starting kanata service..."
    
    # First, try to load the service if it's not loaded
    if ! sudo launchctl list "$KANATA_SERVICE" &>/dev/null; then
        info "Loading service..."
        # Try to load the service
        if sudo launchctl load -w "$KANATA_PLIST" 2>/dev/null; then
            info "Service loaded"
        fi
    fi
    
    info "Service started successfully"
}

# Stop kanata service
stop_service() {
    if ! check_service; then
        info "Service '$KANATA_SERVICE' is not running"
        return 0
    fi
    
    info "Stopping kanata service..."
    
    
    # Then unload the service
    info "Unloading service..."
    if sudo launchctl unload -w "$KANATA_PLIST" 2>/dev/null; then
        info "Service stopped and unloaded successfully"
    fi
}

# Restart kanata service
restart_service() {
    if ! check_service; then
        error "Cannot restart: service '$KANATA_SERVICE' is not loaded"
    fi
    
    info "Restarting kanata service..."
    
    # Try to unload first (ignore errors if not loaded)
    sudo launchctl unload "$KANATA_PLIST" 2>/dev/null || \
        sudo launchctl bootout "gui/$(id -u)/$KANATA_SERVICE" 2>/dev/null || true
    
    # Small delay
    sleep 0.5
    
    # Load the service
    if sudo launchctl load "$KANATA_PLIST" 2>/dev/null; then
        info "Service restarted successfully"
    else
        # Try alternative: bootstrap (macOS 10.10+)
        sudo launchctl bootstrap "gui/$(id -u)" "$KANATA_PLIST" 2>/dev/null || \
            error "Failed to restart kanata service. Check your launchctl plist configuration: $KANATA_PLIST"
    fi
}

# Switch to a config
use_config() {
    local config_name="$1"
    
    if [[ -z "$config_name" ]]; then
        error "Usage: kanage use <config-name>"
    fi
    
    check_config_dir
    
    local config_file="${KANATA_CONFIG_DIR}/${config_name}.kbd"
    
    if [[ ! -f "$config_file" ]]; then
        error "Config file not found: $config_file"
    fi
    
    info "Switching to config: $config_name"
    
    # Backup existing default.kbd if it exists and is not a symlink
    if [[ -f "$KANATA_CONFIG_FILE" ]] && [[ ! -L "$KANATA_CONFIG_FILE" ]]; then
        local backup="${KANATA_CONFIG_FILE}.backup.$(date +%s)"
        warn "Backing up existing config to $backup"
        cp "$KANATA_CONFIG_FILE" "$backup"
    fi
    
    # Remove existing default.kbd (works for both files and symlinks)
    rm -f "$KANATA_CONFIG_FILE"
    
    # Create symlink to the target config
    ln -s "${config_name}.kbd" "$KANATA_CONFIG_FILE"
    
    info "Created symlink: $KANATA_CONFIG_FILE -> ${config_name}.kbd"
    
    # Restart the service
    restart_service
}

# Show logs
show_logs() {
    check_service || warn "Service may not be running"
    
    if [[ ! -f "$KANATA_LOG" ]]; then
        error "Log file not found: $KANATA_LOG"
    fi
    
    info "Showing kanata logs (press Ctrl+C to exit)..."
    tail -f "$KANATA_LOG"
}

# List available configs
list_configs() {
    check_config_dir
    
    info "Available kanata configs:"
    
    local configs=()
    while IFS= read -r -d '' file; do
        local basename=$(basename "$file" .kbd)
        if [[ "$basename" != "default" ]]; then
            configs+=("$basename")
        fi
    done < <(find "$KANATA_CONFIG_DIR" -maxdepth 1 -name "*.kbd" -type f -print0 2>/dev/null)
    
    if [[ ${#configs[@]} -eq 0 ]]; then
        warn "No config files found in $KANATA_CONFIG_DIR"
        return
    fi
    
    # Check current config
    local current=""
    if [[ -L "$KANATA_CONFIG_FILE" ]]; then
        current=$(readlink "$KANATA_CONFIG_FILE" | sed 's/\.kbd$//')
    fi
    
    for config in "${configs[@]}"; do
        if [[ "$config" == "$current" ]]; then
            echo -e "  ${GREEN}* $config${NC} (current)"
        else
            echo "    $config"
        fi
    done
}

# Show current status
show_status() {
    check_config_dir

    echo "=== Current Config ==="
    
    if [[ ! -f "$KANATA_CONFIG_FILE" ]]; then
        warn "No kanata.kbd found"
        return
    fi
    
    if [[ -L "$KANATA_CONFIG_FILE" ]]; then
        local target=$(readlink "$KANATA_CONFIG_FILE")
        local config_name=$(basename "$target" .kbd)
        echo -e "Active config: ${GREEN}$config_name${NC}"
    else
        echo "Active config: kanata.kbd (regular file)"
        warn "Consider using 'kanage use <config>' to switch configs"
    fi

    echo ""
    echo "=== Kanata Service ==="
    echo "Service: $KANATA_SERVICE"
    
    if check_system_service "$KANATA_SERVICE"; then
        echo -e "Status: ${GREEN}Running${NC}"
    else
        echo -e "Status: ${RED}Not running${NC}"
    fi
    
    if [[ -f "$KANATA_PLIST" ]]; then
        echo "Plist: $KANATA_PLIST"
        if sudo plutil -lint "$KANATA_PLIST" &>/dev/null; then
            echo -e "  Plist validation: ${GREEN}Valid${NC}"
        else
            echo -e "  Plist validation: ${RED}Invalid${NC}"
        fi
    else
        echo "Plist: $KANATA_PLIST (not found)"
    fi
    
    echo ""
    echo "=== Karabiner Manager Service ==="
    echo "Service: $KARABINER_MANAGER_SERVICE"
    
    if check_system_service "$KARABINER_MANAGER_SERVICE"; then
        echo -e "Status: ${GREEN}Running${NC}"
    else
        echo -e "Status: ${RED}Not running${NC}"
    fi
    
    if [[ -f "$KARABINER_MANAGER_PLIST" ]]; then
        echo "Plist: $KARABINER_MANAGER_PLIST"
        if sudo plutil -lint "$KARABINER_MANAGER_PLIST" &>/dev/null; then
            echo -e "  Plist validation: ${GREEN}Valid${NC}"
        else
            echo -e "  Plist validation: ${RED}Invalid${NC}"
        fi
    else
        echo "Plist: $KARABINER_MANAGER_PLIST (not found)"
    fi
    
    echo ""
    echo "=== Karabiner Daemon Service ==="
    echo "Service: $KARABINER_DAEMON_SERVICE"
    
    if check_system_service "$KARABINER_DAEMON_SERVICE"; then
        echo -e "Status: ${GREEN}Running${NC}"
    else
        echo -e "Status: ${RED}Not running${NC}"
    fi
    
    if [[ -f "$KARABINER_DAEMON_PLIST" ]]; then
        echo "Plist: $KARABINER_DAEMON_PLIST"
        if sudo plutil -lint "$KARABINER_DAEMON_PLIST" &>/dev/null; then
            echo -e "  Plist validation: ${GREEN}Valid${NC}"
        else
            echo -e "  Plist validation: ${RED}Invalid${NC}"
        fi
    else
        echo "Plist: $KARABINER_DAEMON_PLIST (not found)"
    fi
}

# Restart command
restart_kanata() {
    restart_service
}

# Install kanata and karabiner services
install_kanata() {
    info "Installing Kanata and Karabiner services..."
    
    # Check if sudo is available
    if ! command -v sudo &>/dev/null; then
        error "sudo is required but not found. Please install sudo or run as root."
    fi
    
    # 1. Fetch & install latest Karabiner DriverKit pkg
    info "Fetching latest Karabiner DriverKit pkg URL..."
    local driverkit_pkg_url=$(
        curl -s "https://api.github.com/repos/pqrs-org/Karabiner-DriverKit-VirtualHIDDevice/releases/latest" |
            jq -r '.assets[] | select(.name|endswith(".pkg")) | .browser_download_url'
    )
    
    if [[ -z "$driverkit_pkg_url" ]]; then
        error "Failed to fetch DriverKit package URL"
    fi
    
    info "Downloading DriverKit from: $driverkit_pkg_url"
    curl -L -o /tmp/karabiner-driverkit.pkg "$driverkit_pkg_url"
    info "Installing DriverKit..."
    sudo installer -pkg /tmp/karabiner-driverkit.pkg -target /
    rm -f /tmp/karabiner-driverkit.pkg
    
    # 2. Install Kanata via Homebrew if not present
    if ! command -v kanata &>/dev/null; then
        info "Installing Kanata via Homebrew..."
        if ! command -v brew &>/dev/null; then
            error "Homebrew is required but not found. Please install Homebrew first."
        fi
        brew install kanata
    else
        info "Kanata is already installed"
    fi
    
    local kanata_bin=$(command -v kanata)
    info "Kanata binary: $kanata_bin"
    
    # Extract service name from plist path or use KANATA_SERVICE
    local service_name="$KANATA_SERVICE"
    local plist_dir=$(dirname "$KANATA_PLIST")
    
    # 3. Write kanata plist file
    info "Creating kanata plist file: $KANATA_PLIST"
    sudo tee "$KANATA_PLIST" >/dev/null <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
  "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0"><dict>
  <key>Label</key><string>${service_name}</string>
  <key>ProgramArguments</key><array>
    <string>${kanata_bin}</string>
    <string>-c</string>
    <string>${KANATA_CONFIG_FILE}</string>
    <string>-d</string>
  </array>
  <key>StandardOutPath</key>
  <string>${KANATA_LOG}</string>
  <key>StandardErrorPath</key>
  <string>${KANATA_LOG}</string>
  <key>RunAtLoad</key><true/>
  <key>OtherJobEnabled</key>
  <dict>
    <key>${KARABINER_MANAGER_SERVICE}</key>
    <true />
  </dict>
</dict></plist>
EOF
    sudo chown root:wheel "$KANATA_PLIST"
    sudo chmod 644 "$KANATA_PLIST"
    
    # Write karabiner daemon plist
    info "Creating karabiner daemon plist file: $KARABINER_DAEMON_PLIST"
    sudo tee "$KARABINER_DAEMON_PLIST" >/dev/null <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
  "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0"><dict>
  <key>Label</key><string>$KARABINER_DAEMON_SERVICE</string>
  <key>ProgramArguments</key><array>
    <string>/Library/Application Support/org.pqrs/Karabiner-DriverKit-VirtualHIDDevice/Applications/Karabiner-VirtualHIDDevice-Daemon.app/Contents/MacOS/Karabiner-VirtualHIDDevice-Daemon</string>
  </array>
  <key>RunAtLoad</key><true/>
  <key>KeepAlive</key><true/>
</dict></plist>
EOF
    sudo chown root:wheel "$KARABINER_DAEMON_PLIST"
    sudo chmod 644 "$KARABINER_DAEMON_PLIST"
    
    # Write karabiner manager plist
    info "Creating karabiner manager plist file: $KARABINER_MANAGER_PLIST"
    sudo tee "$KARABINER_MANAGER_PLIST" >/dev/null <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
  "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0"><dict>
  <key>Label</key><string>${KARABINER_MANAGER_SERVICE}</string>
  <key>ProgramArguments</key><array>
    <string>/Applications/.Karabiner-VirtualHIDDevice-Manager.app/Contents/MacOS/Karabiner-VirtualHIDDevice-Manager</string>
    <string>activate</string>
  </array>
  <key>RunAtLoad</key><true/>
  <key>OtherJobEnabled</key>
  <dict>
    <key>${KARABINER_DAEMON_SERVICE}</key>
    <true />
  </dict>
</dict></plist>
EOF
    sudo chown root:wheel "$KARABINER_MANAGER_PLIST"
    sudo chmod 644 "$KARABINER_MANAGER_PLIST"
    
    # 4. Bootstrap and enable services
    info "Bootstrapping and enabling services..."
    
    # Kanata
    sudo launchctl bootout system "$KANATA_PLIST" 2>/dev/null || true
    sudo launchctl bootstrap system "$KANATA_PLIST"
    sudo launchctl enable "system/${service_name}"
    
    # Karabiner-VHIDDaemon
    sudo launchctl bootout system "$KARABINER_DAEMON_PLIST" 2>/dev/null || true
    sudo launchctl bootstrap system "$KARABINER_DAEMON_PLIST"
    sudo launchctl enable system/$KARABINER_DAEMON_SERVICE
    
    # Karabiner-VHIDManager
    sudo launchctl bootout system "$KARABINER_MANAGER_PLIST" 2>/dev/null || true
    sudo launchctl bootstrap system "$KARABINER_MANAGER_PLIST"
    sudo launchctl enable system/$KARABINER_MANAGER_SERVICE
    
    info "Services installed and enabled successfully!"
    
    # 5. Prompt for permissions
    echo ""
    warn "You'll need to grant permissions for Kanata and Karabiner to work properly."
    echo ""
    
    echo -e "${YELLOW}1.${NC} Allow Karabiner to use a system extension."
    echo "   On the next screen, approve the extension when prompted."
    read -rp "Press Enter to open System Extensions..."
    open "x-apple.systempreferences:com.apple.LoginItems-Settings.extension"
    echo ""
    read -rp "Press Enter once you're done..."
    echo ""
    
    echo -e "${YELLOW}2.${NC} Add Kanata to Accessibility settings."
    echo "   On the next screen:"
    echo "   - Click '+' to add a new item"
    echo "   - Press Shift+Command+G and enter ${YELLOW}/opt/homebrew/bin${NC}"
    echo "   - Select the Kanata binary"
    read -rp "Press Enter to open Accessibility settings..."
    open "x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility"
    echo ""
    read -rp "Press Enter once you're done..."
    echo ""
    
    echo -e "${YELLOW}3.${NC} Add Kanata to Input Monitoring as well."
    echo "   Follow the same steps as before."
    read -rp "Press Enter to open Input Monitoring settings..."
    open "x-apple.systempreferences:com.apple.preference.security?Privacy_ListenEvent"
    echo ""
    read -rp "Press Enter once you're done..."
    echo ""
    
    info "Installation complete! Kanata and Karabiner services are now installed and enabled."
    info "Make sure to create your kanata config files in: $KANATA_CONFIG_DIR"
}

# Uninstall kanata and karabiner services
uninstall_kanata() {
    warn "This will uninstall Kanata and Karabiner services."
    read -p "Are you sure you want to continue? [y/N] " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        info "Uninstall cancelled."
        return 0
    fi
    
    info "Uninstalling Kanata and Karabiner services..."
    
    # Check if sudo is available
    if ! command -v sudo &>/dev/null; then
        error "sudo is required but not found. Please install sudo or run as root."
    fi
    
    # 1. Unload services in reverse dependency order (with -w flag)
    # Order: Kanata -> Karabiner Manager -> Karabiner Daemon
    info "Unloading services..."
    
    # Kanata (depends on manager)
    if sudo launchctl list "system/${KANATA_SERVICE}" &>/dev/null; then
        info "Unloading kanata service..."
        sudo launchctl bootout system "$KANATA_PLIST" 2>/dev/null || \
            sudo launchctl unload -w "$KANATA_PLIST" 2>/dev/null || true
    fi
    
    # Karabiner Manager (depends on daemon)
    if sudo launchctl list "system/${KARABINER_MANAGER_SERVICE}" &>/dev/null; then
        info "Unloading karabiner manager service..."
        sudo launchctl bootout system "$KARABINER_MANAGER_PLIST" 2>/dev/null || \
            sudo launchctl unload -w "$KARABINER_MANAGER_PLIST" 2>/dev/null || true
    fi
    
    # Karabiner Daemon (no dependencies)
    if sudo launchctl list "system/${KARABINER_DAEMON_SERVICE}" &>/dev/null; then
        info "Unloading karabiner daemon service..."
        sudo launchctl bootout system "$KARABINER_DAEMON_PLIST" 2>/dev/null || \
            sudo launchctl unload -w "$KARABINER_DAEMON_PLIST" 2>/dev/null || true
    fi
    
    sleep 1
    
    # 2. Disable services
    info "Disabling services..."
    sudo launchctl disable "system/${KANATA_SERVICE}" 2>/dev/null || true
    sudo launchctl disable "system/${KARABINER_MANAGER_SERVICE}" 2>/dev/null || true
    sudo launchctl disable "system/${KARABINER_DAEMON_SERVICE}" 2>/dev/null || true
    
    # 3. Remove plist files
    info "Removing plist files..."
    if [[ -f "$KANATA_PLIST" ]]; then
        sudo rm -f "$KANATA_PLIST"
        info "Removed: $KANATA_PLIST"
    fi
    
    if [[ -f "$KARABINER_MANAGER_PLIST" ]]; then
        sudo rm -f "$KARABINER_MANAGER_PLIST"
        info "Removed: $KARABINER_MANAGER_PLIST"
    fi
    
    if [[ -f "$KARABINER_DAEMON_PLIST" ]]; then
        sudo rm -f "$KARABINER_DAEMON_PLIST"
        info "Removed: $KARABINER_DAEMON_PLIST"
    fi
    
    # 4. Uninstall kanata via Homebrew
    if command -v kanata &>/dev/null; then
        if command -v brew &>/dev/null; then
            info "Uninstalling Kanata via Homebrew..."
            brew uninstall kanata 2>/dev/null || warn "Failed to uninstall kanata via Homebrew"
        else
            warn "Homebrew not found. Please uninstall kanata manually."
        fi
    else
        info "Kanata is not installed via Homebrew"
    fi
    
    # 5. Uninstall Karabiner DriverKit
    local deactivate_script="/Library/Application Support/org.pqrs/Karabiner-DriverKit-VirtualHIDDevice/scripts/uninstall/deactivate_driver.sh"
    local remove_script="/Library/Application Support/org.pqrs/Karabiner-DriverKit-VirtualHIDDevice/scripts/uninstall/remove_files.sh"
    
    if [[ -f "$deactivate_script" ]]; then
        info "Deactivating Karabiner DriverKit..."
        sudo bash "$deactivate_script" 2>/dev/null || warn "Failed to deactivate Karabiner DriverKit"
    fi
    
    if [[ -f "$remove_script" ]]; then
        info "Removing Karabiner DriverKit files..."
        sudo bash "$remove_script" 2>/dev/null || warn "Failed to remove Karabiner DriverKit files"
    fi
    
    info "Uninstall complete!"
}

# Get current active config name
get_current_config() {
    if [[ -L "$KANATA_CONFIG_FILE" ]]; then
        local target=$(readlink "$KANATA_CONFIG_FILE")
        basename "$target" .kbd
    else
        echo ""
    fi
}

# Edit a config file
edit_config() {
    local config_name="$1"
    
    if [[ -z "$config_name" ]]; then
        error "Usage: kanage edit <config-name>"
    fi
    
    check_config_dir
    
    local config_file="${KANATA_CONFIG_DIR}/${config_name}.kbd"
    
    if [[ ! -f "$config_file" ]]; then
        error "Config file not found: $config_file"
    fi
    
    # Check if this is the current active config
    local current_config=$(get_current_config)
    local is_active=false
    if [[ "$config_name" == "$current_config" ]]; then
        is_active=true
        info "Editing active config: $config_name"
    else
        info "Editing config: $config_name (not currently active)"
    fi
    
    # Open the file in the editor
    if ! command -v "$EDITOR" &>/dev/null; then
        error "Editor '$EDITOR' not found. Set KANAGE_EDITOR environment variable to use a different editor."
    fi
    
    "$EDITOR" "$config_file"
    
    # If it was the active config, ask if user wants to reload
    if [[ "$is_active" == "true" ]]; then
        echo ""
        read -p "Reload kanata service to apply changes? [y/N] " -n 1 -r
        echo ""
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            restart_service
            info "Config reloaded"
        else
            info "Config not reloaded. Use 'kanage restart' to apply changes later."
        fi
    fi
}

# Main command dispatcher
main() {
    local command="${1:-}"
    
    case "$command" in
        use)
            if [[ -z "${2:-}" ]]; then
                error "Usage: kanage use <config-name>"
            fi
            use_config "$2"
            ;;
        log)
            show_logs
            ;;
        list)
            list_configs
            ;;
        status)
            show_status
            ;;
        restart)
            restart_kanata
            ;;
        start)
            start_service
            ;;
        stop)
            stop_service
            ;;
        edit)
            if [[ -z "${2:-}" ]]; then
                error "Usage: kanage edit <config-name>"
            fi
            edit_config "$2"
            ;;
        install)
            install_kanata
            ;;
        uninstall)
            uninstall_kanata
            ;;
        help|--help|-h)
            cat << EOF
kanage - Kanata Config Manager

Usage:
  kanage install              Install kanata and karabiner services
  kanage uninstall            Uninstall kanata and karabiner services
  kanage use <config-name>    Switch to a config and restart kanata
  kanage edit <config-name>   Edit a config file (default editor: nvim)
  kanage log                   Show kanata service logs
  kanage list                  List available configs
  kanage status                Show current status and active config
  kanage start                 Start kanata service
  kanage stop                  Stop kanata service
  kanage restart               Restart kanata service
  kanage help                  Show this help message

Environment Variables:
  KANAGE_EDITOR               Editor to use for 'edit' command (default: nvim)

Examples:
  kanage use colemak          Switch to colemak config
  kanage edit colemak         Edit colemak config
  kanage log                  View kanata logs
  kanage list                 List all available configs
EOF
            ;;
        "")
            error "No command specified. Use 'kanage help' for usage."
            ;;
        *)
            error "Unknown command: $command. Use 'kanage help' for usage."
            ;;
    esac
}

main "$@"

